# PRD: Orchestrator Plugin - Attack Tagging System

**Version**: 1.0  
**Author**: Tony (Detection & Automation Engineer Intern)  
**Organization**: Triskele Labs  
**Date**: January 6, 2026

---

## Problem Statement

**Current State**: Detection Engineers at TL Labs spend 20+ minutes per purple team session manually identifying and closing SIEM alerts generated by Caldera operations. This manual process:
- Reduces attack throughput from 30+ to 5 techniques per 4-hour session
- Creates risk of missing real attacks hidden among simulation noise
- Wastes billable hours on non-value-added tasks

**Pain Points**:
- No automated way to distinguish purple team attacks from real threats
- Kibana dashboards show 1000+ alerts (90% are simulations)
- DEs must manually query operation IDs and timestamps to filter

## Solution

Automatic SIEM tagging plugin that intercepts Caldera operation lifecycle events and injects metadata into Elasticsearch, enabling instant Kibana filtering.

## User Stories

### Story 1: Automatic Tagging (Primary)
**As a** Detection Engineer  
**I want** operations automatically tagged in Elasticsearch  
**So that** I can filter simulation logs with one Kibana query

**Acceptance Criteria**:
- Operation metadata appears in ELK within 10 seconds of operation start
- Metadata includes: operation_id, purple_team_exercise flag, techniques, timestamps
- Kibana filter `NOT purple_team_exercise:true` hides 100% of simulation logs
- Zero manual intervention required

### Story 2: Fallback Logging (Resilience)
**As a** Detection Engineer  
**I want** operation metadata logged to files when ELK is unavailable  
**So that** I don't lose telemetry during infrastructure outages

**Acceptance Criteria**:
- Fallback JSON files created in `data/fallback_logs/` when ELK POST fails
- Files contain identical metadata structure as ELK documents
- Manual import script available to backfill ELK after recovery
- No data loss under any failure scenario

### Story 3: Health Monitoring (Observability)
**As a** Purple Team Lead  
**I want** system health checks before client exercises  
**So that** I can catch infrastructure issues before demos

**Acceptance Criteria**:
- REST API endpoint `/api/v2/health` returns ELK status, memory, disk
- Health check completes in <5 seconds
- Clear error messages for degraded states

## Success Metrics

| Metric | Target | Measurement Method |
|--------|--------|-------------------|
| Tagging Latency | <10 seconds | `timestamp(ELK POST) - timestamp(operation start)` |
| Tagging Success Rate | >99.5% | `(successful tags / total operations) * 100` |
| Memory Overhead | <50MB | `ps aux` memory delta before/after plugin load |
| Kibana Filter Accuracy | 100% | Manual verification with 20 test operations |
| Zero Manual Closures | 0 per session | DE time-tracking logs |

## Technical Requirements

### Functional
1. **Event Subscription**: Subscribe to `operation` exchange events (`state_changed`, `completed`) via Caldera `event_svc`
2. **Async ELK Client**: Connection-pooled AsyncElasticsearch client with retry logic
3. **Metadata Schema**: Structured JSON matching ELK index mapping
4. **Error Handling**: Graceful degradation to file logging on ELK failures
5. **Configuration**: Externalized config in `.env` and `conf/local.yml`

### Non-Functional
- **Performance**: <5ms overhead per operation lifecycle event
- **Reliability**: 99.9% uptime (resilient to ELK outages)
- **Scalability**: Handle 100+ concurrent operations without memory leaks
- **Observability**: Structured logging for all actions (INFO/ERROR levels)
- **Testability**: 90%+ test coverage with unit + integration tests

## Implementation Status

### âœ… Completed Features
- [x] Plugin directory structure
- [x] Configuration loader with validation
- [x] ELK tagger service with security controls
- [x] Input validation and sanitization
- [x] Circuit breaker pattern
- [x] Fallback file logging
- [x] Unit test suite (15 tests)
- [x] Event-based service integration
- [x] Graceful shutdown handling

### ðŸ”„ In Progress
- [ ] Integration testing
- [ ] Production deployment documentation

### ðŸ“‹ Future Enhancements (Post-POC)
- [ ] Real-time alert dashboards
- [ ] Multi-tenant client data isolation
- [ ] Slack/email notifications
- [ ] Attack chain visualization
- [ ] Threat intelligence enrichment

## Dependencies

- Elasticsearch 8.11+ or 9.2+
- Python `elasticsearch` library (async client)
- Caldera `event_svc` event bus system
- `.env` configuration management

## Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|-----------|
| ELK connection failures | High | Fallback file logging + retry logic |
| Memory leaks in long-running ops | Medium | Async cleanup + connection pooling |
| Schema drift (ELK vs code) | Low | Versioned index templates |
| Concurrent operation overload | Medium | Semaphore limiting (5 concurrent max) |

## Acceptance Criteria (Demo Checklist)

- [x] Plugin loads on Caldera startup (no errors in logs)
- [ ] Run test operation â†’ metadata appears in Kibana within 10 seconds
- [ ] Kibana filter `NOT purple_team_exercise:true` hides 100% of simulation logs
- [ ] Stop ELK â†’ run operation â†’ fallback file created
- [ ] Unit tests pass with >90% coverage
- [ ] Integration test with live ELK passes

## Security Considerations

### Input Validation
- âœ… Operation ID validation (alphanumeric + hyphens only)
- âœ… Technique ID validation (MITRE ATT&CK format)
- âœ… Metadata sanitization (XSS/injection prevention)
- âœ… Client ID sanitization (path traversal prevention)

### Resource Protection
- âœ… Connection pooling (prevent resource exhaustion)
- âœ… Circuit breaker (auto-disable on failures)
- âœ… Request timeout (35s max)
- âœ… Concurrent operation limiting (5 max)
- âœ… Technique truncation (500 max per operation)

### Operational Security
- âœ… API key support (never hardcode credentials)
- âœ… SSL/TLS verification (configurable)
- âœ… Secrets in environment variables only
- âœ… Error logging without sensitive data exposure

## Known Limitations

1. **ELK Dependency**: Plugin requires Elasticsearch for full functionality
2. **Event Timing**: Relies on Caldera's event_svc timing (not guaranteed real-time)
3. **Fallback Manual Import**: No automated script for fallback log import yet
4. **Single Index**: All operations tagged to same index (no multi-tenancy)

## Support & Maintenance

**Maintainer**: Tony (Detection & Automation Engineer Intern)  
**Contact**: [Internal Slack: #purple-team]  
**Documentation**: See `EXAMPLES.md` for usage guide  
**Issues**: Report via GitHub Issues on fork repository

---

*Last Updated: January 3, 2026*
